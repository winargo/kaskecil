doctype html
head
  meta(http-equiv='Content-Type' content='text/html; charset=UTF-8')
  // Meta, title, CSS, favicons, etc.
  meta(charset='utf-8')
  meta(http-equiv='X-UA-Compatible' content='IE=edge')
  meta(name='viewport' content='width=device-width, initial-scale=1')
  title Chart Of Balance
  link(href='https://cdn.datatables.net/1.10.19/css/dataTables.material.min.css' rel='stylesheet')
  link(href='https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css' rel='stylesheet')
  //- link(href='https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css' rel='stylesheet')
  //- link(href='https://cdn.datatables.net/1.10.19/css/dataTables.semanticui.min.css' rel='stylesheet')
  link(href='https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css' rel='stylesheet')
  link(href='https://cdn.datatables.net/buttons/1.5.6/css/buttons.semanticui.min.css' rel='stylesheet')

  // Bootstrap
  link(rel='stylesheet' href='../vendors/bootstrap/dist/css/bootstrap.min.css')
  
  // Font Awesome
  link(rel='stylesheet' href='../vendors/font-awesome/css/font-awesome.min.css' )
  // NProgress
  link(href='../vendors/nprogress/nprogress.css' rel='stylesheet')
  // bootstrap-daterangepicker
  link(href='../vendors/bootstrap-daterangepicker/daterangepicker.css' rel='stylesheet')
  // Custom Theme Style
  link(href='../build/css/custom.min.css' rel='stylesheet')
  
  //- script(src='https://code.jquery.com/jquery-3.3.1.slim.min.js' integrity='sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo' crossorigin='anonymous')
  //- script(src='https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js' integrity='sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy' crossorigin='anonymous')

  // jQuery
  script(type="text/javascript" src='../vendors/jquery/dist/jquery.min.js')
  // Bootstrap
  script(type="text/javascript" src='../vendors/bootstrap/dist/js/bootstrap.min.js')

  //- <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
  //- <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
  script(src="https://www.gstatic.com/charts/loader.js")

body.nav-md
  .container.body
    .main_container
      .col-md-3.left_col
        .left_col.scroll-view
          .navbar.nav_title(style='border: 0;')
            a.site_title.d-flex.p-3.bg-secondary(href='index.html')
              img.img-circle(src='../images/logo.jpg')
              span &nbsp;Prima Cash
          .clearfix
          // menu profile quick info
          .profile.clearfix
            .profile_pic
              img.img-circle.profile_img(src='../images/img.jpg' alt='...')
            .profile_info
              span Welcome,
              h2 #{username}
          // /menu profile quick info
          br
          // sidebar menu
          #sidebar-menu.main_menu_side.hidden-print.main_menu
            .menu_section
              h3 General
              ul.nav.side-menu
                li
                  a(href='/dashboard')
                    i.fa.fa-home
                    |  Home 
                li
                  a(href='/account')
                    i.fa.fa-users
                    |  Account 
                li
                  a(href='/category')
                    i.fa.fa-list-ol
                    |  Category 
                li
                  a
                    i.fa.fa-money
                    |  Transaction 
                    span.fa.fa-chevron-down
                  ul.nav.child_menu
                    li
                      a(href='/income') Income
                    li
                      a(href='/expense') Expense
                    li
                      a(href='/transfer') Transfer
                li
                  a
                    i.fa.fa-clipboard
                    |  Report
                    span.fa.fa-chevron-down
                  ul.nav.child_menu
                    li.active
                      a(href='/report/ac') Account&amp;Category Report
                    li
                      a Chart Of Balance
                    li
                      a(href='media_gallery.html') Expense Report
                    li
                      a(href='typography.html') Transfer Report
                li
                  a
                    i.fa.fa-bar-chart-o
                    |  Charts 
                    span.fa.fa-chevron-down
                  ul.nav.child_menu
                    li
                      a(href='general_elements.html') Income Chart
                    li
                      a(href='media_gallery.html') Expense Chart
                    li
                      a(href='typography.html') Transfer Chart
                    li
                      a(href='chart.html') All Chart
            .menu_section
              h3 Live On
              ul.nav.side-menu
                li
                  a
                    i.fa.fa-bug
                    |  Additional Pages 
                    span.fa.fa-chevron-down
                  ul.nav.child_menu
                    li
                      a(href='e_commerce.html') E-commerce
                    li
                      a(href='projects.html') Projects
                    li
                      a(href='project_detail.html') Project Detail
                    li
                      a(href='contacts.html') Contacts
                    li
                      a(href='profile.html') Profile
                li
                  a
                    i.fa.fa-windows
                    |  Extras 
                    span.fa.fa-chevron-down
                  ul.nav.child_menu
                    li
                      a(href='page_403.html') 403 Error
                    li
                      a(href='page_404.html') 404 Error
                    li
                      a(href='page_500.html') 500 Error
                    li
                      a(href='plain_page.html') Plain Page
                    li
                      a(href='login.html') Login Page
                    li
                      a(href='pricing_tables.html') Pricing Tables
                li
                  a
                    i.fa.fa-sitemap
                    |  Multilevel Menu 
                    span.fa.fa-chevron-down
                  ul.nav.child_menu
                    li
                      a(href='#level1_1') Level One
                    li
                      a
                        | Level One
                        span.fa.fa-chevron-down
                      ul.nav.child_menu
                        li.sub_menu
                          a(href='level2.html') Level Two
                        li
                          a(href='#level2_1') Level Two
                        li
                          a(href='#level2_2') Level Two
                    li
                      a(href='#level1_2') Level One
                li
                  a(href='javascript:void(0)')
                    i.fa.fa-laptop
                    |  Landing Page 
                    span.label.label-success.pull-right Coming Soon
          // /sidebar menu
          // /menu footer buttons
          .sidebar-footer.hidden-small
            a(data-toggle='tooltip' data-placement='top' title='Settings')
              span.glyphicon.glyphicon-cog(aria-hidden='true')
            a(data-toggle='tooltip' data-placement='top' title='FullScreen')
              span.glyphicon.glyphicon-fullscreen(aria-hidden='true')
            a#refresh(data-toggle='tooltip' data-placement='top' title='Refresh')
              span.glyphicon.glyphicon-refresh(aria-hidden='true')
            a(data-toggle='tooltip' data-placement='top' title='Logout' onclick='logout();')
              span.glyphicon.glyphicon-log-out(aria-hidden='true')
          // /menu footer buttons
      // top navigation

      .top_nav
        .nav_menu
          nav
            .nav.toggle
              a#menu_toggle
                i.fa.fa-bars
            ul.nav.navbar-nav.navbar-right
              li
                a.user-profile.dropdown-toggle(href='javascript:;' data-toggle='dropdown' aria-expanded='false')
                  img(src='../images/img.jpg' alt='')
                  | #{username}
                  span.fa.fa-angle-down
                ul.dropdown-menu.dropdown-usermenu.pull-right
                  li
                    a(href='javascript:;')  Profile
                  li
                    a(href='javascript:;')
                      span.badge.bg-red.pull-right 50%
                      span Settings
                  li
                    a(href='javascript:;') Help
                  li
                    a(onclick='logout();')
                      i.fa.fa-sign-out.pull-right
                      |  Log Out
              li.dropdown(role='presentation')
                a.dropdown-toggle.info-number(href='javascript:;' data-toggle='dropdown' aria-expanded='false')
                  i.fa.fa-envelope-o
                  span.badge.bg-green 6
                ul#menu1.dropdown-menu.list-unstyled.msg_list(role='menu')
                  li
                    a
                      span.image
                        img(src='../images/img.jpg' alt='Profile Image')
                      span
                        span John Smith
                        span.time 3 mins ago
                      span.message
                        | Film festivals used to be do-or-die moments for movie makers. They were where...
                  li
                    a
                      span.image
                        img(src='../images/img.jpg' alt='Profile Image')
                      span
                        span John Smith
                        span.time 3 mins ago
                      span.message
                        | Film festivals used to be do-or-die moments for movie makers. They were where...
                  li
                    a
                      span.image
                        img(src='../images/img.jpg' alt='Profile Image')
                      span
                        span John Smith
                        span.time 3 mins ago
                      span.message
                        | Film festivals used to be do-or-die moments for movie makers. They were where...
                  li
                    a
                      span.image
                        img(src='../images/img.jpg' alt='Profile Image')
                      span
                        span John Smith
                        span.time 3 mins ago
                      span.message
                        | Film festivals used to be do-or-die moments for movie makers. They were where...
                  li
                    .text-center
                      a
                        strong See All Alerts
                        i.fa.fa-angle-right

      // /top navigation
      // page content
      .right_col(role='main')
        .row.top_tiles
          .col-md-12
            .x_panel
              .x_title
                h2
                  | Account&amp;Category Report
                  // Button trigger modal
                
                ul.navbar-right.panel_toolbox(style='list-style-type: none;')
                  li
                    a.collapse-link
                      i.fa.fa-chevron-up
                .clearfix
              .x_content
                .row(style='border-bottom: 1px solid #E0E0E0; padding-bottom: 5px; margin-bottom: 5px;')
                  form
                    .row.w3-margin-bottom
                      .col-md-8
                      .col-md-2
                        | Select Account Name
                        select#accname.form-control(onchange="filterchart()")
                          option(value="All") Select All
                          each x in listacc
                            option(value=""+[x.account_name]) #{x.account_name}
                      .col-md-2
                        | Range Date
                        input#datepickerchart.form-control(type='text' name='date' disabled onchange="filterchart()")
                        input#selectalldatechart(type="checkbox" checked onchange="filterchart()")
                        label(for="selectalldatechart") Select All Date
                  each p in listacc
                    
                    .row.w3-margin-bottom(id="row"+[p.account_name])
                      h3(style='margin-left:24px') Account Name : #{p.account_name}
                      .table-responsive-md.col-md-12
                        table.table.table-hover.table-striped.table-bordered(id="tableChart"+[p.account_name] cellpadding="1" cellspacing="1")
                          thead
                            tr
                              td Account Name
                              td Account Currency
                              td Account Category
                              td Account Balance
                              td Not Included
                              td Type Transaction
                              td Transaction Date
                              td Debit Balance
                              td Credit Balance
                              td Account Balance Current
      // page content
      // footer content
      footer
        .pull-right
          | Gentelella - Bootstrap Admin Template by 
          a(href='https://colorlib.com') Colorlib
        .clearfix
      // footer content
  script(src="../js/axios.min.js")
    // FastClick
  script(type="text/javascript" src='../vendors/fastclick/lib/fastclick.js')
  // NProgress
  script(type="text/javascript" src='../vendors/nprogress/nprogress.js')
  // Chart.js
  script(type="text/javascript" src='../vendors/Chart.js/dist/Chart.min.js')
  // jQuery Sparklines
  script(type="text/javascript" src='../vendors/jquery-sparkline/dist/jquery.sparkline.min.js')
  // Flot
  script(type="text/javascript" src='../vendors/Flot/jquery.flot.js')
  script(type="text/javascript" src='../vendors/Flot/jquery.flot.pie.js')
  script(type="text/javascript" src='../vendors/Flot/jquery.flot.time.js')
  script(type="text/javascript" src='../vendors/Flot/jquery.flot.stack.js')
  script(type="text/javascript" src='../vendors/Flot/jquery.flot.resize.js')
  // Flot plugins
  script(type="text/javascript" src='../vendors/flot.orderbars/js/jquery.flot.orderBars.js')
  script(type="text/javascript" src='../vendors/flot-spline/js/jquery.flot.spline.min.js')
  script(type="text/javascript" src='../vendors/flot.curvedlines/curvedLines.js')
  // DateJS
  script(type="text/javascript" src='../vendors/DateJS/build/date.js')
  // bootstrap-daterangepicker
  script(type="text/javascript" src='../vendors/moment/min/moment.min.js')
  script(type="text/javascript" src='../vendors/bootstrap-daterangepicker/daterangepicker.js')
  // Custom Theme Scripts
  script(type="text/javascript" src='../build/js/custom.min.js')
  script(type="text/javascript" src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js")

  script(type="text/javascript" src='https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js')
  
  script(type="text/javascript" src='https://cdn.datatables.net/1.10.19/js/dataTables.semanticui.min.js')
  script(type="text/javascript" src='https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js')
  script(type="text/javascript" src='https://cdn.datatables.net/buttons/1.5.6/js/buttons.semanticui.min.js')
  script(type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js')
  script(type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js')
  script(type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js')
  script(type="text/javascript" src='https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js')
  script(type="text/javascript" src='https://cdn.datatables.net/1.10.19/js/dataTables.material.min.js')

  script(src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.js")
  script(src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js")
  script(src="https://cdnjs.cloudflare.com/ajax/libs/money.js/0.2.0/money.min.js")

  //- script(type="text/javascript" src='https://cdn.datatables.net/buttons/1.5.6/js/buttons.semanticui.min.js')
  //- script(type="text/javascript" src='https://cdn.datatables.net/buttons/1.5.6/js/buttons.semanticui.min.js')

  //- script(type='text/javascript' charset="utf8" src='https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js')

  script.
    $(function() {
      $('#datepickerchart').daterangepicker({
        showDropdowns: true,
        opens: 'left'
      }, function(start, end, label) {
        console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
        
      });
    });
    var dataaccount=[], dataincome=[], dataexpense=[], datatransfer=[], datachart=[], datacategory=[];
    var dataaccountfilter=[], dataincomefilter=[], dataexpensefilter=[], datatransferfilter=[], datachartfilter=[];
    var accname;
    var notincluded=0;
    var nameacc;
    var firstchart=true;
    
    datepicker=document.getElementById("datepicker");
    nameacc=document.getElementById("nameacc");
    axios.get('/report/cobreport')
    .then(response =>{
      dataaccount=response.data.dataaccount;
      datachart=response.data.datachart;
      console.log(datachart);
      
      $(document).ready(function() {
        var temp=[];
        for(var i=0;i<dataaccount.length;i++){
          temp=[];
          for(var j=0;j<datachart.length;j++){
            if(dataaccount[i]["account_name"]==datachart[j]["account_name"]){
              temp.push(datachart[j]);
            }
          }
          $('#tableChart'+dataaccount[i]["account_name"]).DataTable({
              keys: true,

              data:temp,
            
              "order": [[ 0, "asc" ]],
              columns: [
                  { data: 'account_name' },
                  { data: 'account_currency' },
                  { data: 'account_category' },
                  { data: 'account_balance' },
                  { data: 'not_included' },
                  { data: 'type_transaction' },
                  { data: 'transaction_date' },
                  { data: 'debit_balance' },
                  { data: 'credit_balance' },
                  { data: 'account_balance_current' }
              ]
            });
        }
        firstchart=false;
      });
    })
    .catch(error =>{
      console.log(error);
    })
      
    
    function filterchart(){
      if(!firstchart){
      datachartfilter=[];
      selectalldatechart=document.getElementById("selectalldatechart");
      datepickerchart=document.getElementById("datepickerchart").value;
      accname=document.getElementById("accname").value;
      if(accname=="All"){
        var datatableChart;
        for(var i=0;i<dataaccount.length;i++){
          datatableChart = document.getElementById('row'+dataaccount[i]["account_name"]).style.display="inline";
        }
      }
      else{
        var datatableChart;
        for(var i=0;i<dataaccount.length;i++){
          if(accname==dataaccount[i]["account_name"]){
            datatableChart = document.getElementById('row'+dataaccount[i]["account_name"]).style.display="inline";
          }
          else{
            datatableChart = document.getElementById('row'+dataaccount[i]["account_name"]).style.display="none";
          }
        }
      }
      if(selectalldatechart.checked){
        document.getElementById("datepickerchart").disabled=true;
          for(var i=0;i<dataaccount.length;i++){
            temp=[];
            for(var j=0;j<datachart.length;j++){
              if(dataaccount[i]["account_name"]==datachart[j]["account_name"]){
                temp.push(datachart[j]);
              }
              
            }
            var datatableChart = $('#tableChart'+dataaccount[i]["account_name"]).DataTable();
            datatableChart.clear();
            datatableChart.rows.add(temp);
            datatableChart.draw();
            
          }
        
        
      }
      else{
        document.getElementById("datepickerchart").disabled=false;

        var fromdate=moment(datepickerchart.substring(0,10)).format("YYYY-MM-DD");
        var todate=moment(datepickerchart.substring(13,23)).format("YYYY-MM-DD");
        for(var j=0;j<dataaccount.length;j++){
          datachartfilter=[];
          var BC=dataaccount[j]["account_balance_current"]
          var balance=dataaccount[j]["account_balance"]
          var arrtemp=[], arrbtemp=[];
          arrtemp=BC.split(" ")
          arrbtemp=balance.split(" ")
          if(arrtemp[0]=="RP"){
            fx.base = "IDR";
            fx.rates = {
              "USD" : 0.000071, // eg. 1 USD === 0.745101 EUR
              "SGD" : 0.000096, // etc...
              "MYR" : 0.000291,
              "IDR" : 1,        // always include the base rate (1:1)
              /* etc */
            }
          }
          console.log(dataaccount[j]["account_name"]+arrtemp[1])
          //- var symbol=BC.substring(0,2);
          notincluded=parseInt(numeral(arrtemp[1]).format('0'));
          console.log("Not Included"+notincluded);
          for(var i=0;i<datachart.length;i++){ 
            
            var indate=moment(datachart[i]["transaction_date"],"DD/MM/YYYY").format("YYYY-MM-DD");
            if(dataaccount[j]["account_name"]==datachart[i]["account_name"]){
              if(moment(fromdate).isSameOrBefore(indate, 'day')){
                if(moment(todate).isSameOrAfter(indate, 'day')){
                  var temp, arrtemps=[],temps;
                  if(datachart[i]["debit_balance"]==0 && datachart[i]["credit_balance"]==0){
                    notincluded-=parseInt(numeral(arrbtemp[1]).format('0'));
                    console.log("A"+notincluded);
                  }
                  else if(datachart[i]["debit_balance"]==0){
                    temp=datachart[i]["credit_balance"];
                    arrtemps=temp.split(" ")
                    if(arrtemps[0]=="RP"){
                      notincluded-=parseInt(arrtemps[1]);
                      console.log("A"+notincluded);
                    }
                    else{
                      temps=parseFloat(fx(parseInt(arrtemps[1])).convert({ from:dataaccount[j]["account_currency"], to:"IDR" })).toFixed(2);
                      notincluded-=parseInt(temps);
                      console.log("Convert"+temps)
                    }
                  }
                  else{
                    temp=datachart[i]["debit_balance"];
                    arrtemps=temp.split(" ")
                    if(arrtemps[0]=="RP"){
                      notincluded+=parseInt(arrtemps[1]);
                      console.log("B"+notincluded);
                    }
                  }
                  
                }
              }
            }
          }
          console.log(notincluded);
          var update;
          for(var i=0;i<datachart.length;i++){ 
            
            var indate=moment(datachart[i]["transaction_date"],"DD/MM/YYYY").format("YYYY-MM-DD");
            console.log(indate);
            if(dataaccount[j]["account_name"]==datachart[i]["account_name"]){
              if(moment(fromdate).isSameOrBefore(indate, 'day')){
                if(moment(todate).isSameOrAfter(indate, 'day')){
                  if(datachart[i]["type_transaction"]=="make account"){
                    update={
                      account_name:dataaccount[j]["account_name"],
                      account_currency:dataaccount[j]["account_currency"],
                      account_category:dataaccount[j]["account_category"],
                      account_balance:datachart[i]["account_balance"],
                      not_included:arrtemp[0]+" "+notincluded,
                      type_transaction:datachart[i]["type_transaction"],
                      transaction_date:datachart[i]["transaction_date"],
                      debit_balance:datachart[i]["debit_balance"],
                      credit_balance:datachart[i]["credit_balance"],
                      account_balance_current:"-",
                    }
                    datachartfilter.push(update);
                  }else{
                    update={
                      account_name:dataaccount[j]["account_name"],
                      account_currency:dataaccount[j]["account_currency"],
                      account_category:dataaccount[j]["account_category"],
                      account_balance:datachart[i]["account_balance"],
                      not_included:arrtemp[0]+" "+notincluded,
                      type_transaction:datachart[i]["type_transaction"],
                      transaction_date:datachart[i]["transaction_date"],
                      debit_balance:datachart[i]["debit_balance"],
                      credit_balance:datachart[i]["credit_balance"],
                      account_balance_current:datachart[i]["account_balance_current"],
                    }
                    datachartfilter.push(update);
                  }
                }
              }
            }
          }
          var datatableChart = $('#tableChart'+dataaccount[j]["account_name"]).DataTable();
          datatableChart.clear();
          datatableChart.rows.add(datachartfilter);
          datatableChart.draw();
        }
        
      }
      //- for(var i=0;i<dataaccount.length;i++){
      //-   var datatableChart = $('#tableChart'+dataaccount[i]["account_name"]).DataTable();
      //-   datatableChart.clear();
      //-   datatableChart.rows.add(datachartfilter);
      //-   datatableChart.draw();
      //- }
      }
    }